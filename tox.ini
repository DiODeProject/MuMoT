[tox]
envlist = py36
[testenv]
extras = 
    test
    docs
passenv = DISPLAY BROWSER TOXENV CI TRAVIS TRAVIS_*
install_command = pip install {opts} {packages}
deps = codecov>=1.4.0
whitelist_externals = 
    bash
    test
    wc
    make
commands = 
    # Ensure ipywidgets Jupyter extension is installed
    jupyter nbextension enable --py --sys-prefix widgetsnbextension

    # Run unit tests and generate code coverage report
    pytest --cov={envsitepackagesdir}/mumot tests

    # Ensure the user manual and regression test Notebooks run *without errors* (do not check for regressions yet)
    # (add --nbdime if running tox locally and want to visualise/explore diffs in web browser)
    pytest --verbose --maxfail=1 --nbval-lax docs/MuMoTuserManual.ipynb
    pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MuMoTtest.ipynb
    pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MiscTests/MuMoTtest_GreekLetters.ipynb
    # pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MiscTests/MuMoTtest_MasterEq.ipynb # currently hangs after showNoiseEqs() for second model?
    pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MiscTests/MuMoTtest_MultiController.ipynb
    pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MiscTests/MuMoTtest_NoiseFixedPoints.ipynb
    pytest --verbose --maxfail=1 --nbval-lax --cov={envsitepackagesdir}/mumot --cov-append TestNotebooks/MiscTests/MuMoTtest_oneDimensionalModels.ipynb
    # Additional example Notebooks (TODO; leave commented)
    # (add --nbdime if running tox locally and want to visualise/explore diffs in web browser)
    #pytest --maxfail=1 --cov={envsitepackagesdir}/mumot --nbval-lax --nbdime TestNotebooks/MuMoTtest.ipynb  # Enable when https://github.com/DiODeProject/MuMoT/issues/157 fixed
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTtest_GreekLetters.ipynb
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTtest_MasterEq.ipynb
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTtest_NoiseFixedPoints.ipynb
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTtest_bifurcation.ipynb
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTtest_oneDimensionalModels.ipynb
    #pytest --maxfail=1 --nbval-lax TestNotebooks/MiscTests/MuMoTuserManual_for_LabPresentation.ipynb

    # Ensure the user manual and regression test Notebooks do not show regressions (TODO; leave commented)
    # (add --nbdime if running tox locally and want to visualise/explore diffs in web browser)
    #pytest --nbval TestNotebooks/MuMoTtest.ipynb

    # Check user manual does not contain output cells
    bash -c 'test $(nbshow --outputs docs/MuMoTuserManual.ipynb | wc -c) -eq 0'  

    # Check we can build the docs
    make --directory docs html
